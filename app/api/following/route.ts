import { NextResponse,getRequestContext } from "next/server"; export const runtime="edge";

function DB(){ return (getRequestContext() as any).DB() as D1Database }
async function resolveId(qs:URLSearchParams,db:any){const id=qs.get("creator_id");if(id&&/^\d+$/.test(id))return +id;const h=qs.get("handle");if(!h)return null;return (await db.prepare("SELECT id FROM creators WHERE handle=?").bind(h).first() as any)?.id??null;}
export async function GET(req:Request){try{const db=(getRequestContext() as any).DB() as any;const url=new URL(req.url);const id=await resolveId(url.searchParams,db);if(!id)return NextResponse.json({ok:false,error:"missing query: pass ?creator_id=… or ?handle=…"});const {results}=await db.prepare("SELECT f.id, c2.handle AS following_handle, c2.display_name AS following_name, f.created_at FROM follows f JOIN creators c2 ON f.following_id=c2.id WHERE f.follower_id=? ORDER BY f.created_at DESC").bind(id).all();return NextResponse.json({ok:true,following:results??[]});}catch(e:any){console.error("/api/following",e);return NextResponse.json({ok:false,error:e.message??String(e)},{status:500});}}